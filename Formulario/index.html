<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inscripci√≥n de Casillas (3 Filas)</title>

  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --success: #28a745;
      --success-light: #b8f5c4;
      --bg: #f0f4f8;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 15px;
    }

    .container {
      background: white;
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #333;
      font-size: 1.4em;
    }

    .row-title {
      margin-top: 15px;
      font-weight: bold;
      color: #333;
    }

    .boxes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 6px;
      margin-top: 8px;
    }

    .box {
      border: 2px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      font-weight: bold;
      background-color: #fff;
      transition: all 0.3s ease;
      cursor: pointer;
      user-select: none;
    }

    .box input[type="checkbox"] {
      display: none;
    }

    .box.taken {
      background-color: var(--success);
      color: white;
      border-color: var(--success);
      cursor: not-allowed;
    }

    .box.selected {
      background-color: var(--success-light);
      border-color: var(--success);
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border: none;
      color: white;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
    }

    button#clear {
      background-color: var(--primary);
    }

    button#clear:hover {
      background-color: var(--primary-dark);
    }

    button[type="submit"] {
      background-color: var(--primary-dark);
      font-weight: bold;
    }

    #newRound {
      background-color: var(--success);
      width: auto;
      padding: 6px 12px;
      font-size: 0.85em;
      border-radius: 6px;
      align-self: flex-end;
      margin-top: 10px;
      cursor: pointer;
    }

    #status {
      text-align: center;
      margin-top: 10px;
      color: var(--success);
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align:center; margin-bottom:0px;">
      <img src="imagenes/bingo.png" 
           alt="Super Bingo" 
           style="max-width: 80%; height: auto; border-radius: 3px;">
    </div>

    <form id="form">
      <label>Nombre:
        <input id="name" type="text" required />
      </label>

      <p class="row-title">Fila 1 (Casillas 1‚Äì15):</p>
      <div id="row1" class="boxes"></div>

      <p class="row-title">Fila 2 (Casillas 1‚Äì15):</p>
      <div id="row2" class="boxes"></div>

      <p class="row-title">Fila 3 (Casillas 1‚Äì15):</p>
      <div id="row3" class="boxes"></div>

      <button type="submit">Enviar</button>
    </form>

    <p id="status"></p>
    <button id="clear">üóëÔ∏è Nueva Elecci√≥n</button>
    <button id="newRound">üåÄ Nueva Ronda</button>
  </div>

  <!-- SDK Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /*************** CONFIGURA ESTO ***************/
    const SUPABASE_URL = "https://rmpjmfkyhqciezcjspfe.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtcGptZmt5aHFjaWV6Y2pzcGZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyOTQ2MDYsImV4cCI6MjA3NTg3MDYwNn0.-yIvCGIUmZ7-HSWAtc680Quu4GkJPh_gMWK8SuwKN-s";
    const ADMIN_PASSWORD = "admin123";
    /*********************************************/

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const STORAGE_KEY = "registro_casillas_3filas";
    const form = document.getElementById("form");
    const nameInput = document.getElementById("name");
    const statusEl = document.getElementById("status");
    const clearBtn = document.getElementById("clear");
    const newRoundBtn = document.getElementById("newRound");
    const TOTAL_BOXES = 15;

    // Crear filas din√°micamente
    ["row1", "row2", "row3"].forEach((rowId) => {
      const container = document.getElementById(rowId);
      for (let i = 1; i <= TOTAL_BOXES; i++) {
        const div = document.createElement("div");
        div.classList.add("box");
        div.innerHTML = `
          <input type="checkbox" value="${i}">
          <strong>${i}</strong>
          <span id="${rowId}-name-${i}"></span>
        `;
        container.appendChild(div);
      }

      // evento de selecci√≥n por fila
      container.addEventListener("click", (e) => {
        const box = e.target.closest(".box");
        if (!box || box.classList.contains("taken")) return;
        container.querySelectorAll(".box").forEach(b => b.classList.remove("selected"));
        box.classList.add("selected");
        box.querySelector("input").checked = true;
      });
    });

    const readStorage = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
    const writeStorage = (obj) => localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    const clearStorage = () => localStorage.removeItem(STORAGE_KEY);

    async function loadRegistered() {
      const { data, error } = await supabaseClient.from("registros_3filas").select("*");
      if (error) {
        console.error("Error al cargar registros:", error);
        return;
      }
      data.forEach(row => {
        for (let r = 1; r <= 3; r++) {
          const choice = row[`choice${r}`];
          if (choice) {
            const box = document.querySelector(`#row${r} .box input[value="${choice}"]`)?.parentElement;
            const nameSpan = document.getElementById(`row${r}-name-${choice}`);
            if (box && nameSpan) {
              nameSpan.textContent = row.name;
              box.classList.add("taken");
              box.querySelector("input").disabled = true;
            }
          }
        }
      });
    }

    function blockAll(message) {
      form.querySelectorAll("input, button").forEach(el => el.disabled = true);
      form.classList.add("disabled");
      statusEl.textContent = message;
    }

    (async () => {
      const saved = readStorage();
      if (saved) {
        nameInput.value = saved.name;
        blockAll(`Ya registraste tus casillas.`);
      }
      await loadRegistered();
    })();

    // üîΩ Aqu√≠ est√° el cambio importante
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const name = nameInput.value.trim();
      if (!name) return alert("Ingrese su nombre.");

      const choices = [1, 2, 3].map(r => {
        const checked = document.querySelector(`#row${r} input[type=checkbox]:checked`);
        return checked ? Number(checked.value) : null;
      });

      // ‚úÖ Nueva validaci√≥n: al menos una casilla seleccionada
      if (choices.every(c => c === null)) {
        return alert("Seleccione al menos una casilla (en cualquier fila).");
      }

      writeStorage({ name, choice1: choices[0], choice2: choices[1], choice3: choices[2] });

      try {
        const { error } = await supabaseClient.from("registros_3filas").insert([
          { name, choice1: choices[0], choice2: choices[1], choice3: choices[2] }
        ]);
        if (error) throw error;
        alert("‚úÖ Registro guardado correctamente.");
        location.reload();
      } catch (err) {
        console.error("Error al guardar:", err);
        alert("‚ùå No se pudo guardar el registro.");
      }
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("¬øBorrar datos locales?")) {
        clearStorage();
        location.reload();
      }
    });

    newRoundBtn.addEventListener("click", async () => {
      const clave = prompt("üîê Ingrese la clave de administrador para continuar:");
      if (clave !== ADMIN_PASSWORD) return alert("‚ùå Clave incorrecta.");
      if (!confirm("¬øSeguro que deseas iniciar una nueva ronda?")) return;

      try {
        const { error } = await supabaseClient.from("registros_3filas").delete().neq("id", 0);
        if (error) throw error;
        alert("üåÄ Nueva ronda iniciada correctamente.");
        clearStorage();
        location.reload();
      } catch (e) {
        console.error("Error al limpiar:", e);
        alert("‚ùå No se pudo reiniciar la ronda.");
      }
    });
  </script>
</body>
</html>